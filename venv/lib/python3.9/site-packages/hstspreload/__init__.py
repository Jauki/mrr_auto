"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.10.1"
__checksum__ = "1205a99f6c3a1675d28211dd5189cbcbf88eb047108912a8af4d765248b1f386"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 16), (352, 10), (362, 28), None, (390, 54), (444, 8), (452, 18), (470, 19), (489, 13), (502, 14), (516, 14), None, None, (530, 33), (563, 20), (583, 35), (618, 14), (632, 24), (656, 9), None, (665, 25), (690, 27), (717, 8), (725, 13), None, None, (738, 17), (755, 6), (761, 26), (787, 5), (792, 5), (797, 19), (816, 14), (830, 11), (841, 12), (853, 27), None, (880, 11), (891, 11), (902, 7), (909, 29), (938, 18), (956, 27), (983, 46), (1029, 25), (1054, 16), (1070, 8), (1078, 5), (1083, 22), (1105, 18), None, (1123, 36), (1159, 15), (1174, 8), (1182, 11), None, (1193, 5), (1198, 16), (1214, 14), (1228, 18), None, (1246, 14), (1260, 18), (1278, 48), (1326, 19), (1345, 12), (1357, 59), (1416, 14), (1430, 14), (1444, 20), None, (1464, 10), (1474, 13), (1487, 20), (1507, 19), None, (1526, 13), (1539, 19), (1558, 11), (1569, 4), (1573, 22), (1595, 10), (1605, 7), (1612, 14), (1626, 21), (1647, 11), (1658, 21), (1679, 12), (1691, 32), None, (1723, 10), (1733, 14), (1747, 12), (1759, 45), (1804, 15), None, (1819, 11), (1830, 23), (1853, 21), (1874, 26), (1900, 6), (1906, 6), (1912, 7), (1919, 5), (1924, 20), (1944, 23), (1967, 24), (1991, 13), (2004, 15), (2019, 19), (2038, 6), (2044, 61), (2105, 44), (2149, 12), (2161, 23), (2184, 16), (2200, 38), (2238, 6), (2244, 12), (2256, 44), (2300, 6), (2306, 41), (2347, 13), (2360, 23), (2383, 30), (2413, 20), (2433, 8), (2441, 15), (2456, 12), (2468, 19), (2487, 21), (2508, 15), None, (2523, 35), (2558, 21), (2579, 17), (2596, 19), (2615, 26), (2641, 5), (2646, 37), (2683, 30), (2713, 16), (2729, 10), (2739, 17), (2756, 23), (2779, 14), (2793, 17), (2810, 8), (2818, 8), (2826, 7), (2833, 29), (2862, 6), (2868, 18), (2886, 27), (2913, 20), (2933, 17), (2950, 19), (2969, 12), (2981, 40), (3021, 40), (3061, 12), (3073, 48), (3121, 25), (3146, 12), None, (3158, 8), (3166, 25), (3191, 19), (3210, 6), (3216, 23), None, (3239, 30), (3269, 33), (3302, 14), (3316, 16), (3332, 27), None, (3359, 30), (3389, 41), (3430, 50), (3480, 15), (3495, 20), (3515, 15), (3530, 21), (3551, 32), (3583, 24), (3607, 20), (3627, 17), (3644, 60), (3704, 19), (3723, 9), (3732, 12), (3744, 12), (3756, 11), (3767, 10), (3777, 48), (3825, 42), None, (3867, 25), (3892, 23), None, (3915, 8), (3923, 8), (3931, 7), None, (3938, 25), (3963, 17), None, (3980, 21), (4001, 35), (4036, 21), (4057, 10), (4067, 36), (4103, 20), (4123, 31), (4154, 23), (4177, 19), (4196, 12), (4208, 5), (4213, 30), (4243, 24), (4267, 14), (4281, 14), (4295, 47), (4342, 52), None, None, (4394, 51), (4445, 42), None, (4487, 14), None, (4501, 15), (4516, 8), (4524, 21), (4545, 6), (4551, 16), (4567, 17)], [(4584, 8434), (13018, 9210), (22228, 9333), (31561, 8015), (39576, 8504), (48080, 8293), (56373, 9120), (65493, 8171), (73664, 9171), (82835, 8383), (91218, 9532), (100750, 8383), (109133, 8883), (118016, 10152), (128168, 8608), (136776, 9021), (145797, 9403), (155200, 8728), (163928, 8620), (172548, 8218), (180766, 9283), (190049, 8932), (198981, 9042), (208023, 8460), (216483, 8996), (225479, 8511), (233990, 9108), (243098, 9168), (252266, 8144), (260410, 8843), (269253, 9114), (278367, 8523), (286890, 8706), (295596, 8921), (304517, 7967), (312484, 8874), (321358, 8723), (330081, 9564), (339645, 9018), (348663, 9048), (357711, 9607), (367318, 8379), (375697, 8335), (384032, 8562), (392594, 8715), (401309, 8675), (409984, 8633), (418617, 9727), (428344, 8527), (436871, 8118), (444989, 8528), (453517, 9028), (462545, 9040), (471585, 8928), (480513, 9169), (489682, 8709), (498391, 9137), (507528, 8733), (516261, 9027), (525288, 7681), (532969, 8741), (541710, 8879), (550589, 8624), (559213, 9061), (568274, 8990), (577264, 9149), (586413, 8437), (594850, 9360), (604210, 9162), (613372, 8855), (622227, 8930), (631157, 8389), (639546, 7831), (647377, 9240), (656617, 8894), (665511, 9507), (675018, 8189), (683207, 9361), (692568, 8961), (701529, 8340), (709869, 9089), (718958, 7554), (726512, 8465), (734977, 9075), (744052, 8411), (752463, 8988), (761451, 9452), (770903, 8800), (779703, 9113), (788816, 8953), (797769, 9642), (807411, 8241), (815652, 8843), (824495, 8751), (833246, 8799), (842045, 9328), (851373, 9030), (860403, 8574), (868977, 8513), (877490, 8176), (885666, 8367), (894033, 8958), (902991, 8608), (911599, 8609), (920208, 8518), (928726, 9352), (938078, 9328), (947406, 9278), (956684, 9885), (966569, 9096), (975665, 9145), (984810, 9153), (993963, 8791), (1002754, 8634), (1011388, 9110), (1020498, 8976), (1029474, 8713), (1038187, 8816), (1047003, 8616), (1055619, 9499), (1065118, 9407), (1074525, 9208), (1083733, 8928), (1092661, 9090), (1101751, 9855), (1111606, 8583), (1120189, 8136), (1128325, 9373), (1137698, 8892), (1146590, 10268), (1156858, 9291), (1166149, 8406), (1174555, 9061), (1183616, 8559), (1192175, 8566), (1200741, 8993), (1209734, 8301), (1218035, 9449), (1227484, 8492), (1235976, 8523), (1244499, 9001), (1253500, 9206), (1262706, 8116), (1270822, 8499), (1279321, 9292), (1288613, 8557), (1297170, 8568), (1305738, 8726), (1314464, 8424), (1322888, 9162), (1332050, 9021), (1341071, 8899), (1349970, 9155), (1359125, 8475), (1367600, 8960), (1376560, 9076), (1385636, 8447), (1394083, 8947), (1403030, 8425), (1411455, 7921), (1419376, 8013), (1427389, 8956), (1436345, 9439), (1445784, 8444), (1454228, 8512), (1462740, 9478), (1472218, 8703), (1480921, 8337), (1489258, 9314), (1498572, 8841), (1507413, 7945), (1515358, 8596), (1523954, 10182), (1534136, 8213), (1542349, 8293), (1550642, 9332), (1559974, 8666), (1568640, 9221), (1577861, 8712), (1586573, 8365), (1594938, 11003), (1605941, 9121), (1615062, 8788), (1623850, 9075), (1632925, 9827), (1642752, 9684), (1652436, 8003), (1660439, 9045), (1669484, 8339), (1677823, 8735), (1686558, 9552), (1696110, 8414), (1704524, 9085), (1713609, 8942), (1722551, 8761), (1731312, 8733), (1740045, 8462), (1748507, 8447), (1756954, 8892), (1765846, 8601), (1774447, 8951), (1783398, 8358), (1791756, 9593), (1801349, 8827), (1810176, 9508), (1819684, 9200), (1828884, 7960), (1836844, 9138), (1845982, 8600), (1854582, 9065), (1863647, 8987), (1872634, 9278), (1881912, 8845), (1890757, 9156), (1899913, 8951), (1908864, 8796), (1917660, 8758), (1926418, 8628), (1935046, 8875), (1943921, 9235), (1953156, 8935), (1962091, 8171), (1970262, 9820), (1980082, 8791), (1988873, 8713), (1997586, 8546), (2006132, 8724), (2014856, 8134), (2022990, 9239), (2032229, 8866), (2041095, 9722), (2050817, 8881), (2059698, 8363), (2068061, 9416), (2077477, 8634), (2086111, 9758), (2095869, 8475), (2104344, 8428), (2112772, 7731), (2120503, 9460), (2129963, 9125), (2139088, 9319), (2148407, 8578), (2156985, 9033), (2166018, 8697), (2174715, 9247), (2183962, 8556), (2192518, 7992), (2200510, 8697), (2209207, 8220), (2217427, 9128), (2226555, 9390), (2235945, 9221), (2245166, 8680), (2253846, 8683), (2262529, 8795)], [(2271324, 933), (2272257, 834), (2273091, 871), (2273962, 1024), (2274986, 712), (2275698, 877), (2276575, 659), (2277234, 1027), (2278261, 721), (2278982, 828), (2279810, 669), (2280479, 713), (2281192, 877), (2282069, 905), (2282974, 1090), (2284064, 1083), (2285147, 1348), (2286495, 762), (2287257, 1052), (2288309, 887), (2289196, 989), (2290185, 950), (2291135, 1047), (2292182, 863), (2293045, 883), (2293928, 784), (2294712, 1167), (2295879, 1367), (2297246, 842), (2298088, 924), (2299012, 1089), (2300101, 892), (2300993, 697), (2301690, 842), (2302532, 997), (2303529, 990), (2304519, 874), (2305393, 932), (2306325, 846), (2307171, 1225), (2308396, 741), (2309137, 1092), (2310229, 875), (2311104, 849), (2311953, 823), (2312776, 576), (2313352, 1108), (2314460, 1106), (2315566, 919), (2316485, 650), (2317135, 939), (2318074, 771), (2318845, 923), (2319768, 1145), (2320913, 1149), (2322062, 639), (2322701, 784), (2323485, 746), (2324231, 711), (2324942, 913), (2325855, 941), (2326796, 881), (2327677, 1202), (2328879, 1114), (2329993, 857), (2330850, 885), (2331735, 859), (2332594, 548), (2333142, 760), (2333902, 735), (2334637, 846), (2335483, 1001), (2336484, 732), (2337216, 923), (2338139, 700), (2338839, 826), (2339665, 714), (2340379, 866), (2341245, 901), (2342146, 602), (2342748, 948), (2343696, 724), (2344420, 1070), (2345490, 770), (2346260, 887), (2347147, 584), (2347731, 862), (2348593, 895), (2349488, 984), (2350472, 903), (2351375, 1129), (2352504, 1312), (2353816, 959), (2354775, 943), (2355718, 860), (2356578, 601), (2357179, 1047), (2358226, 963), (2359189, 688), (2359877, 799), (2360676, 895), (2361571, 1078), (2362649, 995), (2363644, 629), (2364273, 753), (2365026, 960), (2365986, 551), (2366537, 604), (2367141, 1125), (2368266, 1085), (2369351, 860), (2370211, 884), (2371095, 808), (2371903, 857), (2372760, 1008), (2373768, 891), (2374659, 746), (2375405, 720), (2376125, 843), (2376968, 769), (2377737, 1170), (2378907, 835), (2379742, 971), (2380713, 570), (2381283, 868), (2382151, 1010), (2383161, 911), (2384072, 1056), (2385128, 797), (2385925, 1135), (2387060, 949), (2388009, 671), (2388680, 1011), (2389691, 810), (2390501, 1014), (2391515, 828), (2392343, 810), (2393153, 776), (2393929, 885), (2394814, 689), (2395503, 775), (2396278, 789), (2397067, 824), (2397891, 651), (2398542, 635), (2399177, 637), (2399814, 764), (2400578, 728), (2401306, 873), (2402179, 728), (2402907, 849), (2403756, 645), (2404401, 665), (2405066, 961), (2406027, 844), (2406871, 778), (2407649, 858), (2408507, 1088), (2409595, 901), (2410496, 743), (2411239, 1115), (2412354, 902), (2413256, 694), (2413950, 888), (2414838, 1131), (2415969, 771), (2416740, 795), (2417535, 784), (2418319, 785), (2419104, 797), (2419901, 922), (2420823, 713), (2421536, 1035), (2422571, 891), (2423462, 972), (2424434, 993), (2425427, 837), (2426264, 663), (2426927, 814), (2427741, 811), (2428552, 2027), (2430579, 709), (2431288, 879), (2432167, 819), (2432986, 1176), (2434162, 891), (2435053, 863), (2435916, 703), (2436619, 704), (2437323, 1046), (2438369, 687), (2439056, 654), (2439710, 933), (2440643, 887), (2441530, 1057), (2442587, 874), (2443461, 867), (2444328, 763), (2445091, 921), (2446012, 809), (2446821, 939), (2447760, 862), (2448622, 953), (2449575, 745), (2450320, 834), (2451154, 714), (2451868, 995), (2452863, 1009), (2453872, 802), (2454674, 1083), (2455757, 807), (2456564, 961), (2457525, 1019), (2458544, 1167), (2459711, 959), (2460670, 863), (2461533, 1028), (2462561, 822), (2463383, 633), (2464016, 490), (2464506, 919), (2465425, 916), (2466341, 631), (2466972, 1146), (2468118, 686), (2468804, 814), (2469618, 969), (2470587, 1007), (2471594, 998), (2472592, 806), (2473398, 1022), (2474420, 805), (2475225, 984), (2476209, 693), (2476902, 725), (2477627, 637), (2478264, 719), (2478983, 486), (2479469, 883), (2480352, 1080), (2481432, 918), (2482350, 777), (2483127, 737), (2483864, 727), (2484591, 1046), (2485637, 658), (2486295, 655), (2486950, 1007), (2487957, 536), (2488493, 1085), (2489578, 2522), (2492100, 769), (2492869, 829), (2493698, 1020), (2494718, 1170), (2495888, 534)], [(2496422, 48), None, (2496470, 35), (2496505, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2496547, 42), None, (2496589, 25), (2496614, 44), (2496658, 22), (2496680, 18), None, None, None, None, (2496698, 26), None, None, None, None, (2496724, 21), (2496745, 25), None, None, (2496770, 26), None, None, None, None, (2496796, 71), (2496867, 21), (2496888, 23), None, None, None, None, (2496911, 48), None, None, None, None, None, (2496959, 31), None, None, None, None, (2496990, 42), None, (2497032, 22), None, (2497054, 21), None, (2497075, 26), (2497101, 42), None, None, (2497143, 77), (2497220, 27), None, None, None, None, (2497247, 21), (2497268, 21), None, None, (2497289, 34), (2497323, 42), None, None, None, (2497365, 25), None, None, (2497390, 21), None, None, None, None, None, (2497411, 24), (2497435, 21), None, None, (2497456, 26), None, (2497482, 18), None, (2497500, 54), None, None, None, None, None, None, (2497554, 26), None, None, None, (2497580, 20), None, None, (2497600, 64), (2497664, 42), (2497706, 17), (2497723, 17), (2497740, 26), None, (2497766, 26), None, None, None, (2497792, 26), (2497818, 20), (2497838, 26), None, (2497864, 42), (2497906, 63), None, None, None, (2497969, 40), (2498009, 48), None, None, None, (2498057, 47), None, None, None, None, None, None, None, (2498104, 42), None, (2498146, 80), None, (2498226, 9), None, (2498235, 21), (2498256, 42), None, None, (2498298, 65), (2498363, 82), (2498445, 21), None, (2498466, 72), None, None, (2498538, 24), (2498562, 21), None, None, None, None, None, (2498583, 42), (2498625, 21), (2498646, 21), None, (2498667, 42), (2498709, 25), None, (2498734, 38), (2498772, 21), (2498793, 56), None, None, (2498849, 21), (2498870, 19), (2498889, 26), None, (2498915, 16), None, (2498931, 21), None, None, (2498952, 38), None, (2498990, 22), (2499012, 21), (2499033, 21), (2499054, 21), None, (2499075, 63), None, (2499138, 21), (2499159, 42), None, (2499201, 17), None, None, None, None, (2499218, 21), (2499239, 21), None, None, (2499260, 21), None, None, (2499281, 21), None, (2499302, 26), None, (2499328, 50), (2499378, 22), None, None, (2499400, 50), (2499450, 26), (2499476, 21), (2499497, 21), (2499518, 19), None, (2499537, 35), (2499572, 26), (2499598, 23), (2499621, 39), (2499660, 42), None, None, None, None, None, None, (2499702, 21), None, None, None, (2499723, 21), None, None, (2499744, 90), None, (2499834, 239), (2500073, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
